<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• L·∫≠p k·∫ø ho·∫°ch Du l·ªãch Th√¥ng minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
         .btn-secondary {
            background-color: #10b981;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #059669;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .modal-open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .prose h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .prose h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .prose ul {
            list-style-type: none;
            padding-left: 0;
        }
        .prose li {
            padding-left: 1.5rem;
            position: relative;
            margin-bottom: 0.5rem;
        }
        .prose li::before {
            content: '‚úì';
            color: #10b981;
            position: absolute;
            left: 0;
            font-weight: bold;
        }
        .prose strong {
            color: #1f2937;
        }
        /* Custom modal for confirmation */
        .confirm-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .confirm-modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 400px;
            text-align: center;
        }
        #budget-modal .confirm-modal-content {
            animation: bounce-in 0.5s;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        .mode-button.active {
            border-bottom-width: 2px;
            border-color: #3b82f6;
            color: #2563eb;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8">
            <i class="fas fa-map-marked-alt text-4xl sm:text-5xl text-blue-600 mb-4"></i>
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">C√¥ng c·ª• L·∫≠p k·∫ø ho·∫°ch Du l·ªãch Th√¥ng minh</h1>
            <p class="text-gray-600 mt-2">D·ª± to√°n chi ph√≠ v√† nh·∫≠n g·ª£i √Ω l·ªãch tr√¨nh cho chuy·∫øn ƒëi c·ªßa b·∫°n!</p>
        </header>
        
        <!-- Mode Switcher -->
        <div class="mb-6 flex justify-center border-b bg-white rounded-t-lg shadow-sm sticky top-0 z-10">
            <button id="mode-auto-btn" class="mode-button flex-1 sm:flex-none px-6 py-3 font-semibold active">
                <i class="fas fa-magic-wand-sparkles mr-2"></i> K·∫ø ho·∫°ch T·ª± ƒë·ªông
            </button>
            <button id="mode-discovery-btn" class="mode-button flex-1 sm:flex-none px-6 py-3 font-semibold text-gray-500">
                <i class="fas fa-compass mr-2"></i> Kh√°m ph√° & T·ª± ch·ªçn
            </button>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-6">
                <!-- Trip Details Card (Shared for both modes) -->
                <div id="trip-details-card" class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-3 mb-4 flex items-center"><i class="fas fa-info-circle mr-3 text-lg text-blue-500"></i>1. Nh·∫≠p th√¥ng tin chuy·∫øn ƒëi</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="starting-point" class="block text-sm font-medium text-gray-600 mb-1">ƒêi·ªÉm xu·∫•t ph√°t</label>
                            <input type="text" id="starting-point" placeholder="V√≠ d·ª•: TP. H·ªì Ch√≠ Minh" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="destination" class="block text-sm font-medium text-gray-600 mb-1">ƒêi·ªÉm ƒë·∫øn</label>
                            <input type="text" id="destination" placeholder="V√≠ d·ª•: ƒê√† L·∫°t" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="trip-duration" class="block text-sm font-medium text-gray-600 mb-1">S·ªë ng√†y (v√≠ d·ª•: 3 ng√†y 2 ƒë√™m)</label>
                            <input type="number" id="trip-duration" placeholder="V√≠ d·ª•: 3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" min="1">
                        </div>
                        <div>
                            <label for="adults" class="block text-sm font-medium text-gray-600 mb-1">S·ªë ng∆∞·ªùi l·ªõn</label>
                            <input type="number" id="adults" placeholder="V√≠ d·ª•: 2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" min="1">
                        </div>
                        <div>
                            <label for="children" class="block text-sm font-medium text-gray-600 mb-1">S·ªë tr·∫ª em</label>
                            <input type="number" id="children" placeholder="V√≠ d·ª•: 1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" min="0">
                        </div>
                        <div id="budget-input-container">
                            <label for="estimated-budget" class="block text-sm font-medium text-gray-600 mb-1">Ng√¢n s√°ch d·ª± ki·∫øn (VNƒê)</label>
                            <input type="text" id="estimated-budget" placeholder="V√≠ d·ª•: 15.000.000" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                        </div>
                         <div class="sm:col-span-2">
                            <label for="accommodation-type" class="block text-sm font-medium text-gray-600 mb-1">Lo·∫°i h√¨nh ch·ªó ·ªü</label>
                            <select id="accommodation-type" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="Kh√°ch s·∫°n th∆∞·ªùng">Kh√°ch s·∫°n th∆∞·ªùng</option>
                                <option value="Homestay">Homestay</option>
                                <option value="Resort">Resort</option>
                                <option value="Kh√°ch s·∫°n 3 sao">Kh√°ch s·∫°n 3 sao</option>
                                <option value="Kh√°ch s·∫°n 4 sao">Kh√°ch s·∫°n 4 sao</option>
                                <option value="Kh√°ch s·∫°n 5 sao">Kh√°ch s·∫°n 5 sao</option>
                            </select>
                        </div>
                        <div>
                            <label for="travel-style" class="block text-sm font-medium text-gray-600 mb-1">Phong c√°ch du l·ªãch</label>
                            <select id="travel-style" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                                <option value="Ti·∫øt ki·ªám">Ti·∫øt ki·ªám</option>
                                <option value="C√¢n b·∫±ng" selected>C√¢n b·∫±ng</option>
                                <option value="Sang tr·ªçng">Sang tr·ªçng</option>
                            </select>
                        </div>
                         <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-gray-600 mb-1">S·ªü th√≠ch</label>
                            <div id="travel-interests-container" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2">
                                <div class="flex items-center">
                                    <input id="interest-am-thuc" name="travel-interest" type="checkbox" value="·∫®m th·ª±c" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="interest-am-thuc" class="ml-2 block text-sm text-gray-900">·∫®m th·ª±c</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="interest-lich-su" name="travel-interest" type="checkbox" value="L·ªãch s·ª≠" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="interest-lich-su" class="ml-2 block text-sm text-gray-900">L·ªãch s·ª≠</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="interest-thien-nhien" name="travel-interest" type="checkbox" value="Thi√™n nhi√™n" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="interest-thien-nhien" class="ml-2 block text-sm text-gray-900">Thi√™n nhi√™n</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="interest-mao-hiem" name="travel-interest" type="checkbox" value="M·∫°o hi·ªÉm" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="interest-mao-hiem" class="ml-2 block text-sm text-gray-900">M·∫°o hi·ªÉm</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="interest-mua-sam" name="travel-interest" type="checkbox" value="Mua s·∫Øm" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="interest-mua-sam" class="ml-2 block text-sm text-gray-900">Mua s·∫Øm</label>
                                </div>
                            </div>
                        </div>
                    </div>
                     <button id="generate-plan-btn" class="w-full mt-6 py-3 px-4 rounded-md font-semibold btn-secondary flex items-center justify-center text-lg">
                        <i class="fas fa-magic-wand-sparkles mr-2"></i>
                        2. T·∫°o k·∫ø ho·∫°ch & Ng√¢n s√°ch t·ª± ƒë·ªông
                    </button>
                </div>
                
                <!-- AUTO PLANNER MODE CONTENT -->
                <div id="auto-planner-mode" class="space-y-6">
                    <!-- Itinerary Suggestion Card -->
                    <div id="itinerary-card" class="card p-6">
                        <h2 class="text-xl font-semibold text-gray-700 border-b pb-3 mb-4 flex items-center"><i class="fas fa-route mr-3 text-lg text-blue-500"></i>L·ªãch tr√¨nh & K·∫ø ho·∫°ch chi ti·∫øt</h2>
                        <div id="itinerary-loader" class="hidden flex justify-center items-center my-4">
                            <div class="loader"></div>
                            <p class="ml-4 text-gray-600">AI ƒëang ph√¢n t√≠ch v√† t·∫°o k·∫ø ho·∫°ch t·ªët nh·∫•t cho b·∫°n, vui l√≤ng ch·ªù trong gi√¢y l√°t...</p>
                        </div>
                        <div id="itinerary-content" class="prose max-w-none text-gray-600">
                            <p class="italic">K·∫ø ho·∫°ch chi ti·∫øt s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t t·∫°o k·∫ø ho·∫°ch.</p>
                        </div>
                    </div>

                    <!-- Budget Categories -->
                    <div id="categories-container" class="space-y-6">
                        <!-- C√°c th·∫ª danh m·ª•c s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·∫±ng JS -->
                    </div>
                </div>

                <!-- DISCOVERY MODE CONTENT -->
                <div id="discovery-mode" class="hidden space-y-6">
                     <div id="discovery-loader" class="hidden flex justify-center items-center my-4 card p-6">
                        <div class="loader"></div>
                        <p class="ml-4 text-gray-600">AI ƒëang t√¨m ki·∫øm nh·ªØng g·ª£i √Ω tuy·ªát v·ªùi nh·∫•t cho b·∫°n...</p>
                    </div>
                    <div id="discovery-content" class="space-y-6">
                        <p class="italic card p-6">C√°c g·ª£i √Ω v·ªÅ ho·∫°t ƒë·ªông, ƒÉn u·ªëng, v√† n∆°i ·ªü s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y ƒë·ªÉ b·∫°n l·ª±a ch·ªçn.</p>
                    </div>
                     <div id="discovery-actions" class="hidden card p-4">
                        <button id="find-more-suggestions-btn" class="w-full py-3 px-4 rounded-md font-semibold btn-primary flex items-center justify-center text-lg disabled:opacity-50" disabled>
                            <i class="fas fa-sync-alt mr-2"></i> T√¨m th√™m g·ª£i √Ω m·ªõi
                        </button>
                    </div>
                </div>
            </div>

            <!-- C·ªôt b√™n ph·∫£i cho T√≥m t·∫Øt & T·ªïng c·ªông -->
            <div class="lg:col-span-1">
                <div class="sticky top-20">
                    <div id="summary-card" class="card p-6">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-4 flex items-center">
                            <i class="fas fa-calculator mr-3 text-blue-500"></i>
                            T√≥m t·∫Øt Ng√¢n s√°ch
                        </h2>
                        
                        <div class="space-y-3 mb-4 text-gray-600">
                             <div id="summary-estimated-container" class="flex justify-between items-center">
                                <span>Ng√¢n s√°ch c·ªßa b·∫°n:</span>
                                <span id="summary-estimated" class="font-medium text-green-600">0 VNƒê</span>
                            </div>
                            <div id="summary-container">
                            </div>
                        </div>

                        <div class="border-t pt-4 space-y-3">
                            <div class="flex justify-between items-center text-xl font-bold">
                                <span id="grand-total-label" class="text-gray-800">T·ªîNG CHI D·ª∞ KI·∫æN:</span>
                                <span id="grand-total" class="text-red-600">0 VNƒê</span>
                            </div>
                            <div id="summary-remaining-container" class="flex justify-between items-center text-xl font-bold">
                                <span class="text-gray-800">CH√äNH L·ªÜCH:</span>
                                <span id="remaining-budget" class="text-blue-600">0 VNƒê</span>
                            </div>
                        </div>
                        <div class="mt-6 space-y-3" id="action-buttons">
                            <button id="download-pdf-button" class="w-full py-2 px-4 rounded-md font-semibold btn-primary flex items-center justify-center disabled:opacity-50" disabled>
                                <i class="fas fa-file-pdf mr-2"></i> T·∫£i K·∫ø ho·∫°ch (PDF)
                            </button>
                            <button id="reset-button" class="w-full py-2 px-4 rounded-md font-semibold btn-danger flex items-center justify-center">
                                <i class="fas fa-trash-alt mr-2"></i>
                                L√†m m·ªõi K·∫ø ho·∫°ch
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Printable area for Discovery PDF -->
    <div id="printable-discovery" class="hidden"></div>


    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="confirm-modal-backdrop hidden">
        <div class="confirm-modal-content">
            <h3 class="text-lg font-bold mb-4">X√°c nh·∫≠n l√†m m·ªõi</h3>
            <p class="mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m m·ªõi to√†n b·ªô k·∫ø ho·∫°ch kh√¥ng? M·ªçi d·ªØ li·ªáu s·∫Ω b·ªã x√≥a.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-yes" class="px-6 py-2 rounded-md btn-danger">Ch·∫Øc ch·∫Øn</button>
                <button id="confirm-no" class="px-6 py-2 rounded-md bg-gray-200 hover:bg-gray-300">H·ªßy b·ªè</button>
            </div>
        </div>
    </div>

    <!-- Insufficient Budget Modal -->
    <div id="budget-modal" class="confirm-modal-backdrop hidden">
        <div class="confirm-modal-content text-center p-8 bg-white rounded-xl shadow-2xl">
            <i class="fas fa-wallet text-5xl text-amber-500 mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">∆† k√¨a, V√≠ ti·ªÅn "kh√≥c th√©t"!</h3>
            <p id="budget-modal-message" class="mb-6 text-gray-600"></p>
            <button id="budget-modal-close" class="px-8 py-2 rounded-md btn-primary">T√¥i hi·ªÉu r·ªìi!</button>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="confirm-modal-backdrop hidden">
        <div class="confirm-modal-content">
            <h3 id="alert-modal-title" class="text-lg font-bold mb-4 text-gray-800">Th√¥ng b√°o</h3>
            <p id="alert-modal-message" class="mb-6 text-gray-600"></p>
            <button id="alert-modal-close" class="px-6 py-2 rounded-md btn-primary">ƒê√£ hi·ªÉu</button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentMode = 'auto'; // 'auto' or 'discovery'
            
            // DOM Elements
            const modeAutoBtn = document.getElementById('mode-auto-btn');
            const modeDiscoveryBtn = document.getElementById('mode-discovery-btn');
            const autoPlannerModeDiv = document.getElementById('auto-planner-mode');
            const discoveryModeDiv = document.getElementById('discovery-mode');
            const grandTotalLabel = document.getElementById('grand-total-label');
            const discoveryContent = document.getElementById('discovery-content');
            const discoveryLoader = document.getElementById('discovery-loader');
            const budgetInputContainer = document.getElementById('budget-input-container');
            const summaryEstimatedContainer = document.getElementById('summary-estimated-container');
            const summaryRemainingContainer = document.getElementById('summary-remaining-container');
            const findMoreSuggestionsBtn = document.getElementById('find-more-suggestions-btn');
            const discoveryActions = document.getElementById('discovery-actions');


            const categoriesContainer = document.getElementById('categories-container');
            const summaryContainer = document.getElementById('summary-container');
            const grandTotalElement = document.getElementById('grand-total');
            const resetButton = document.getElementById('reset-button');
            const summaryEstimatedElement = document.getElementById('summary-estimated');
            const remainingBudgetElement = document.getElementById('remaining-budget');
            
            const startingPointInput = document.getElementById('starting-point');
            const destinationInput = document.getElementById('destination');
            const durationInput = document.getElementById('trip-duration');
            const adultsInput = document.getElementById('adults');
            const childrenInput = document.getElementById('children');
            const estimatedBudgetInput = document.getElementById('estimated-budget');
            const accommodationTypeInput = document.getElementById('accommodation-type');
            const travelStyleInput = document.getElementById('travel-style');
            
            const generatePlanBtn = document.getElementById('generate-plan-btn');
            const itineraryContent = document.getElementById('itinerary-content');
            const itineraryLoader = document.getElementById('itinerary-loader');

            const confirmModal = document.getElementById('confirm-modal');
            const confirmYesBtn = document.getElementById('confirm-yes');
            const confirmNoBtn = document.getElementById('confirm-no');

            const budgetModal = document.getElementById('budget-modal');
            const budgetModalMessage = document.getElementById('budget-modal-message');
            const budgetModalCloseBtn = document.getElementById('budget-modal-close');

            const downloadPdfButton = document.getElementById('download-pdf-button');

            const alertModal = document.getElementById('alert-modal');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertModalMessage = document.getElementById('alert-modal-message');
            const alertModalClose = document.getElementById('alert-modal-close');

            const wittyMessages = [
                "C√≥ v·∫ª nh∆∞ k·∫ø ho·∫°ch n√†y h∆°i 'qu√° s·ª©c' v·ªõi v√≠ ti·ªÅn c·ªßa b·∫°n r·ªìi. Th√™m 'ƒë·∫°n' ƒëi n√†o!",
                "Ng√¢n s√°ch c·ªßa b·∫°n ƒëang 'bi·ªÉu t√¨nh' ƒë√≤i tƒÉng l∆∞∆°ng ƒë√≥!",
                "B·∫°n ∆°i, v√≠ ti·ªÅn mu·ªën 'nh·∫£y l·∫ßu' v·ªõi k·∫ø ho·∫°ch n√†y r·ªìi. C·ª©u n√≥ ƒëi!",
                "K·∫ø ho·∫°ch 5 sao nh∆∞ng ng√¢n s√°ch 1 sao. M√¨nh ƒëi·ªÅu ch·ªânh ch√∫t nha!",
                "Alo alo, ng√¢n h√†ng v√≠ v·ª´a g·ªçi. H·ªç b·∫£o s·ªë d∆∞ c·ªßa b·∫°n kh√¥ng ƒë·ªß 'qu·∫©y' cho chuy·∫øn n√†y ƒë√¢u!"
            ];

            let budgetData = JSON.parse(localStorage.getItem('travelBudget')) || {
                details: {
                    startingPoint: '', destination: '', duration: '', adults: 1, children: 0,
                    estimatedBudget: 0, accommodationType: 'Kh√°ch s·∫°n th∆∞·ªùng',
                    style: 'C√¢n b·∫±ng',
                    interests: []
                },
                categories: [
                    { id: 'transportation', name: 'Di chuy·ªÉn', icon: 'fa-plane-departure', items: [] },
                    { id: 'accommodation', name: 'Ch·ªó ·ªü', icon: 'fa-hotel', items: [] },
                    { id: 'food', name: 'ƒÇn u·ªëng', icon: 'fa-utensils', items: [] },
                    { id: 'activities', name: 'Ho·∫°t ƒë·ªông & Tham quan', icon: 'fa-camera-retro', items: [] },
                    { id: 'misc', name: 'Chi ph√≠ kh√°c', icon: 'fa-shopping-bag', items: [] }
                ],
                itineraryHTML: '<p class="italic">K·∫ø ho·∫°ch chi ti·∫øt s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y sau khi b·∫°n nh·∫•n n√∫t t·∫°o k·∫ø ho·∫°ch.</p>'
            };
            
            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
            
            const saveData = () => {
                budgetData.itineraryHTML = itineraryContent.innerHTML;
                localStorage.setItem('travelBudget', JSON.stringify(budgetData));
            }

            const updateActionButtonsState = () => {
                const hasContent = (currentMode === 'auto' && budgetData.categories.some(c => c.items.length > 0)) ||
                                   (currentMode === 'discovery' && discoveryContent.querySelector('.discovery-item') !== null);

                downloadPdfButton.disabled = !hasContent;

                if (currentMode === 'discovery') {
                    const hasSuggestions = discoveryContent.querySelector('.discovery-item') !== null;
                    findMoreSuggestionsBtn.disabled = !hasSuggestions;
                }
            };

            const switchMode = (newMode) => {
                currentMode = newMode;
                if (newMode === 'auto') {
                    modeAutoBtn.classList.add('active');
                    modeDiscoveryBtn.classList.remove('active');
                    autoPlannerModeDiv.classList.remove('hidden');
                    discoveryModeDiv.classList.add('hidden');
                    budgetInputContainer.classList.remove('hidden');
                    summaryEstimatedContainer.classList.remove('hidden');
                    summaryRemainingContainer.classList.remove('hidden');
                    grandTotalLabel.textContent = 'T·ªîNG CHI D·ª∞ KI·∫æN:';
                    generatePlanBtn.innerHTML = '<i class="fas fa-magic-wand-sparkles mr-2"></i> 2. T·∫°o k·∫ø ho·∫°ch & Ng√¢n s√°ch t·ª± ƒë·ªông';
                } else {
                    modeAutoBtn.classList.remove('active');
                    modeDiscoveryBtn.classList.add('active');
                    autoPlannerModeDiv.classList.add('hidden');
                    discoveryModeDiv.classList.remove('hidden');
                    budgetInputContainer.classList.add('hidden');
                    summaryEstimatedContainer.classList.add('hidden');
                    summaryRemainingContainer.classList.add('hidden');
                    grandTotalLabel.textContent = 'T·ªîNG CHI PH√ç ƒê√É CH·ªåN:';
                    generatePlanBtn.innerHTML = '<i class="fas fa-search-location mr-2"></i> 2. T√¨m G·ª£i √Ω & L√™n k·∫ø ho·∫°ch';
                }
                updateTotals(); 
                updateActionButtonsState();
            };
            modeAutoBtn.addEventListener('click', () => switchMode('auto'));
            modeDiscoveryBtn.addEventListener('click', () => switchMode('discovery'));

            
            const loadDetails = () => {
                const { details } = budgetData;
                startingPointInput.value = details.startingPoint || '';
                destinationInput.value = details.destination || '';
                durationInput.value = details.duration || '';
                adultsInput.value = details.adults || 1;
                childrenInput.value = details.children || 0;
                estimatedBudgetInput.value = details.estimatedBudget ? new Intl.NumberFormat('vi-VN').format(details.estimatedBudget) : '';
                accommodationTypeInput.value = details.accommodationType || 'Kh√°ch s·∫°n th∆∞·ªùng';
                travelStyleInput.value = details.style || 'C√¢n b·∫±ng';
                const interests = details.interests || [];
                document.querySelectorAll('input[name="travel-interest"]').forEach(checkbox => {
                    checkbox.checked = interests.includes(checkbox.value);
                });
                itineraryContent.innerHTML = budgetData.itineraryHTML;
            };
            
            const saveDetails = () => {
                const selectedInterests = [];
                document.querySelectorAll('input[name="travel-interest"]:checked').forEach(checkbox => {
                    selectedInterests.push(checkbox.value);
                });
                const rawBudget = estimatedBudgetInput.value.replace(/\./g, '');
                budgetData.details = {
                    startingPoint: startingPointInput.value,
                    destination: destinationInput.value,
                    duration: parseInt(durationInput.value) || 1,
                    adults: parseInt(adultsInput.value) || 1,
                    children: parseInt(childrenInput.value) || 0,
                    estimatedBudget: parseFloat(rawBudget) || 0,
                    accommodationType: accommodationTypeInput.value,
                    style: travelStyleInput.value,
                    interests: selectedInterests
                };
                updateTotals();
                saveData();
            };
            
            [startingPointInput, destinationInput, durationInput, adultsInput, childrenInput, accommodationTypeInput, travelStyleInput].forEach(input => {
                input.addEventListener('change', saveDetails);
            });
            estimatedBudgetInput.addEventListener('blur', saveDetails); // Save on blur for budget
            document.querySelectorAll('input[name="travel-interest"]').forEach(checkbox => {
                checkbox.addEventListener('change', saveDetails);
            });
            
            // Format budget input dynamically
            const formatNumberInput = (input) => {
                let value = input.value.replace(/\./g, ''); // Remove existing dots
                let numberValue = parseInt(value, 10);
                if (isNaN(numberValue)) {
                    input.value = '';
                    return;
                }
                input.value = new Intl.NumberFormat('vi-VN').format(numberValue);
            };
            estimatedBudgetInput.addEventListener('input', () => formatNumberInput(estimatedBudgetInput));


            const updateTotals = () => {
                let grandTotal = 0;
                summaryContainer.innerHTML = '';
                
                if (currentMode === 'auto') {
                    budgetData.categories.forEach(category => {
                        const categoryTotal = category.items.reduce((sum, item) => sum + (item.cost || 0), 0);
                        grandTotal += categoryTotal;
                        const categoryTotalElement = document.getElementById(`total-${category.id}`);
                        if (categoryTotalElement) categoryTotalElement.textContent = formatCurrency(categoryTotal);

                        if (categoryTotal > 0) {
                            const summaryItem = document.createElement('div');
                            summaryItem.className = 'flex justify-between items-center';
                            summaryItem.innerHTML = `<div class="flex items-center text-sm"><i class="fas ${category.icon} mr-2 text-gray-400"></i><span>${category.name}</span></div><span class="font-medium text-sm">${formatCurrency(categoryTotal)}</span>`;
                            summaryContainer.appendChild(summaryItem);
                        }
                    });
                } else { // Discovery Mode
                    grandTotal = updateDiscoveryTotal();
                }

                const estimatedBudget = budgetData.details.estimatedBudget || 0;
                const remainingBudget = estimatedBudget - grandTotal;

                grandTotalElement.textContent = formatCurrency(grandTotal);
                summaryEstimatedElement.textContent = formatCurrency(estimatedBudget);
                remainingBudgetElement.textContent = formatCurrency(remainingBudget);
                
                remainingBudgetElement.classList.toggle('text-red-600', remainingBudget < 0);
                remainingBudgetElement.classList.toggle('text-blue-600', remainingBudget >= 0);

                saveData();
                updateActionButtonsState();
            };
            
            const renderCategoryItems = (categoryId) => {
                const category = budgetData.categories.find(c => c.id === categoryId);
                const itemsList = document.getElementById(`items-${categoryId}`);
                if (!itemsList) return;

                itemsList.innerHTML = category.items.length === 0
                    ? '<p class="text-sm text-gray-500 italic">Ch∆∞a c√≥ m·ª•c n√†o ƒë∆∞·ª£c th√™m.</p>'
                    : category.items.map(item => `
                        <li class="flex justify-between items-center p-2 rounded-md hover:bg-gray-50">
                            <span>${item.description}</span>
                            <div class="flex items-center space-x-3">
                                <span class="font-medium text-gray-700">${formatCurrency(item.cost)}</span>
                            </div>
                        </li>`).join('');
            };
            
            const renderUI = () => {
                categoriesContainer.innerHTML = '';
                budgetData.categories.forEach(category => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'card p-6';
                    categoryCard.innerHTML = `
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                                <i class="fas ${category.icon} mr-3 text-lg w-6 text-center text-blue-500"></i> ${category.name}
                            </h3>
                        </div>
                        <ul id="items-${category.id}" class="space-y-2 mb-4"></ul>
                        <div class="border-t pt-3 flex justify-between items-center font-semibold">
                            <span>T·ªïng c·ªông:</span><span id="total-${category.id}">0 VNƒê</span>
                        </div>`;
                    categoriesContainer.appendChild(categoryCard);
                    renderCategoryItems(category.id);
                });
                loadDetails();
                updateTotals();
            };

            const formatItineraryFromJSON = (planData) => {
                if (!planData || !planData.dailyPlan) return '<p>L·ªói ƒë·ªãnh d·∫°ng d·ªØ li·ªáu l·ªãch tr√¨nh.</p>';
                let html = planData.dailyPlan.map(day => {
                    let dayHtml = `<h2>Ng√†y ${day.day}</h2><ul>`;
                    dayHtml += day.activities.map(activity => `<li><strong>${activity.description}:</strong> ${formatCurrency(activity.estimatedCost)}</li>`).join('');
                    dayHtml += '</ul>';
                    return dayHtml;
                }).join('');
                html += `<h2 class="text-green-600">T·ªïng chi ph√≠ d·ª± ki·∫øn: ${formatCurrency(planData.totalEstimatedCost)}</h2>`;
                return html;
            };

            const handleAutoMode = async (details) => {
                const { startingPoint, destination, duration, accommodationType, adults, children, estimatedBudget, style, interests } = details;
                 const userPrompt = `B·∫°n l√† m·ªôt chuy√™n gia l·∫≠p k·∫ø ho·∫°ch du l·ªãch t·∫°i Vi·ªát Nam. H√£y t·∫°o m·ªôt k·∫ø ho·∫°ch du l·ªãch chi ti·∫øt v√† th·ª±c t·∫ø cho y√™u c·∫ßu sau:
                - Chuy·∫øn ƒëi t·ª´: ${startingPoint}
                - ƒê·∫øn: ${destination}
                - Th·ªùi gian: ${duration} ng√†y (nghƒ©a l√† ${duration > 1 ? duration - 1 : 1} ƒë√™m)
                - S·ªë l∆∞·ª£ng: ${adults} ng∆∞·ªùi l·ªõn v√† ${children} tr·∫ª em
                - Lo·∫°i h√¨nh l∆∞u tr√∫: ${accommodationType}
                - Phong c√°ch du l·ªãch: ${style}
                - S·ªü th√≠ch: ${interests.join(', ')}
                - Ng√¢n s√°ch ng∆∞·ªùi d√πng ƒë∆∞a ra: ${formatCurrency(estimatedBudget)}

                Y√™u c·∫ßu ƒë·∫ßu ra PH·∫¢I l√† m·ªôt chu·ªói JSON h·ª£p l·ªá, KH√îNG ch·ª©a b·∫•t k·ª≥ markdown (nh∆∞ \`\`\`json) hay vƒÉn b·∫£n gi·∫£i th√≠ch n√†o kh√°c. Ch·ªâ tr·∫£ v·ªÅ ƒë·ªëi t∆∞·ª£ng JSON. C·∫•u tr√∫c JSON nh∆∞ sau:
                {
                  "totalEstimatedCost": number,
                  "isBudgetFeasible": boolean,
                  "feasibilityMessage": string,
                   "alternativeSuggestions": { "style": string | null, "interests": string[] | null },
                  "dailyPlan": [ { "day": number, "activities": [ { "description": string, "estimatedCost": number, "category": "transportation" | "accommodation" | "food" | "activities" | "misc" } ] } ]
                }
                Trong ƒë√≥:
                - "totalEstimatedCost": T·ªïng chi ph√≠ th·ª±c t·∫ø b·∫°n d·ª± ki·∫øn cho to√†n b·ªô chuy·∫øn ƒëi d·ª±a tr√™n k·∫ø ho·∫°ch b·∫°n t·∫°o.
                - "isBudgetFeasible": So s√°nh "totalEstimatedCost" v·ªõi ng√¢n s√°ch ng∆∞·ªùi d√πng. Tr·∫£ v·ªÅ false n·∫øu ng√¢n s√°ch ng∆∞·ªùi d√πng th·∫•p h∆°n ƒë√°ng k·ªÉ (d∆∞·ªõi 85% chi ph√≠ b·∫°n d·ª± ki·∫øn).
                - "feasibilityMessage": N·∫øu "isBudgetFeasible" l√† false, h√£y vi·∫øt m·ªôt c√¢u tr·∫£ l·ªùi th√¢n thi·ªán b·∫±ng ti·∫øng Vi·ªát.
                - "alternativeSuggestions": CH·ªà ƒëi·ªÅn v√†o ƒë·ªëi t∆∞·ª£ng n√†y n·∫øu "isBudgetFeasible" l√† false. D·ª±a tr√™n ng√¢n s√°ch, h√£y g·ª£i √Ω m·ªôt "style" v√† "interests" ph√π h·ª£p h∆°n.
                - "dailyPlan": L·∫≠p k·∫ø ho·∫°ch chi ti·∫øt cho t·ª´ng ng√†y.`;

                itineraryLoader.classList.remove('hidden');
                itineraryContent.innerHTML = '';
                
                try {
                    const planData = await callGeminiAPI(userPrompt);
                    if (!planData.isBudgetFeasible) {
                        const randomMessage = wittyMessages[Math.floor(Math.random() * wittyMessages.length)];
                        let suggestionMessage = '';
                        if (planData.alternativeSuggestions) {
                            const { style, interests } = planData.alternativeSuggestions;
                            let suggestions = [];
                            if (style) suggestions.push(`phong c√°ch <strong>'${style}'</strong>`);
                            if (interests && interests.length > 0) suggestions.push(`s·ªü th√≠ch nh∆∞ <strong>'${interests.join(', ')}'</strong>`);
                            if (suggestions.length > 0) {
                                suggestionMessage = `<br><br><div class="mt-4 p-3 bg-blue-50 rounded-lg text-left text-sm"><p class="font-semibold text-blue-800">üí° G·ª£i √Ω:</p><p class="text-blue-700">V·ªõi ng√¢n s√°ch n√†y, b·∫°n c√≥ th·ªÉ c√¢n nh·∫Øc ${suggestions.join(' v√† ')} ƒë·ªÉ c√≥ m·ªôt chuy·∫øn ƒëi tuy·ªát v·ªùi h∆°n.</p></div>`;
                            }
                        }
                        budgetModalMessage.innerHTML = `${randomMessage}<br><br><i class="text-sm">${planData.feasibilityMessage}</i>${suggestionMessage}`;
                        budgetModal.classList.remove('hidden');
                        itineraryContent.innerHTML = `<p class="text-lg text-amber-700 font-semibold p-4 bg-amber-100 rounded-md">Vui l√≤ng ƒëi·ªÅu ch·ªânh l·∫°i ng√¢n s√°ch ho·∫∑c th√¥ng tin chuy·∫øn ƒëi.</p>`;
                        budgetData.categories.forEach(c => c.items = []);
                    } else {
                        itineraryContent.innerHTML = formatItineraryFromJSON(planData);
                        budgetData.categories.forEach(c => c.items = []);
                        planData.dailyPlan.forEach(day => {
                            day.activities.forEach(activity => {
                                const category = budgetData.categories.find(c => c.id === activity.category);
                                if (category) category.items.push({ description: `Ng√†y ${day.day}: ${activity.description}`, cost: activity.estimatedCost });
                            });
                        });
                    }
                    renderUI();
                } catch (error) {
                    console.error('Error in Auto Mode:', error);
                    itineraryContent.innerHTML = `<p class="text-red-600 font-semibold p-4 bg-red-100 rounded-md">ƒê√£ c√≥ l·ªói x·∫£y ra: ${error.message}</p>`;
                } finally {
                    itineraryLoader.classList.add('hidden');
                }
            };

            const handleDiscoveryMode = async (details, isRefresh = false) => {
                const { destination, duration, adults, children, style, interests, startingPoint, accommodationType } = details;
                let userPrompt;
                
                if (isRefresh) {
                    const checkedItems = [];
                    const uncheckedItems = [];
                    document.querySelectorAll('.discovery-item:not([data-category="mainTransportation"])').forEach(el => {
                        const itemData = { id: el.id, name: el.dataset.name };
                        if (el.checked) checkedItems.push(itemData);
                        else uncheckedItems.push(itemData);
                    });

                    const checkedNames = checkedItems.map(item => item.name).join(', ') || 'kh√¥ng c√≥';
                    const uncheckedNames = uncheckedItems.map(item => item.name).join(', ');

                    userPrompt = `L√† m·ªôt chuy√™n gia du l·ªãch Vi·ªát Nam, h√£y ƒë·ªÅ xu·∫•t c√°c l·ª±a ch·ªçn M·ªöI v√† KH√ÅC BI·ªÜT cho chuy·∫øn ƒëi ƒë·∫øn ${destination}.
                     - Ng∆∞·ªùi d√πng ƒë√£ ch·ªçn v√† mu·ªën gi·ªØ c√°c m·ª•c sau: ${checkedNames}.
                     - Ng∆∞·ªùi d√πng kh√¥ng th√≠ch v√† mu·ªën thay th·∫ø c√°c g·ª£i √Ω sau: ${uncheckedNames}.
                     - Vui l√≤ng cung c·∫•p c√°c g·ª£i √Ω ho√†n to√†n m·ªõi cho c√°c danh m·ª•c Ch·ªó ·ªü, ƒÇn u·ªëng, v√† Ho·∫°t ƒë·ªông, KH√îNG l·∫∑p l·∫°i nh·ªØng g·ª£i √Ω ƒë√£ b·ªã t·ª´ ch·ªëi v√† KH√îNG g·ª£i √Ω l·∫°i ph·∫ßn di chuy·ªÉn.
                     - Th√¥ng tin chuy·∫øn ƒëi: ${duration} ng√†y, ${adults} ng∆∞·ªùi l·ªõn, ${children} tr·∫ª em, t·ª´ ${startingPoint}, phong c√°ch ${style}, s·ªü th√≠ch ${interests.join(', ')}.
                     QUAN TR·ªåNG: C√°c g·ª£i √Ω "accommodation" M·ªöI PH·∫¢I ph√π h·ª£p v·ªõi lo·∫°i h√¨nh ng∆∞·ªùi d√πng ƒë√£ ch·ªçn: '${accommodationType}'.
                     Y√™u c·∫ßu ƒë·∫ßu ra PH·∫¢I l√† m·ªôt chu·ªói JSON h·ª£p l·ªá, kh√¥ng c√≥ markdown hay text n√†o kh√°c, ch·ªâ ch·ª©a c√°c g·ª£i √Ω M·ªöI. C·∫•u tr√∫c JSON:
                     { 
                        "suggestions": { 
                            "accommodation": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "perNight" } ], 
                            "food": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "perPersonPerMeal" } ], 
                            "activities": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "perPerson" } ] 
                        } 
                     }`;
                } else {
                    userPrompt = `L√† m·ªôt chuy√™n gia du l·ªãch Vi·ªát Nam, h√£y ƒë·ªÅ xu·∫•t c√°c l·ª±a ch·ªçn cho chuy·∫øn ƒëi t·ª´ ${startingPoint} ƒë·∫øn ${destination} trong ${duration} ng√†y cho ${adults} ng∆∞·ªùi l·ªõn v√† ${children} tr·∫ª em, phong c√°ch ${style}, s·ªü th√≠ch ${interests.join(', ')}.
                     Y√™u c·∫ßu ƒë·∫ßu ra PH·∫¢I l√† m·ªôt chu·ªói JSON h·ª£p l·ªá, kh√¥ng c√≥ markdown hay text n√†o kh√°c. C·∫•u tr√∫c JSON:
                     {
                       "suggestions": {
                         "mainTransportation": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "perPersonRoundtrip" } ],
                         "internalTransportation": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "fixedForTrip" | "perDay" } ],
                         "accommodation": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "perNight" } ],
                         "food": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "perPersonPerMeal" } ],
                         "activities": [ { "id": string, "name": string, "description": string, "estimatedCost": number, "unit": "perPerson" } ]
                       }
                     }
                     QUAN TR·ªåNG: 
                     - C√°c g·ª£i √Ω "accommodation" PH·∫¢I ph√π h·ª£p v·ªõi lo·∫°i h√¨nh ng∆∞·ªùi d√πng ƒë√£ ch·ªçn: '${accommodationType}'.
                     - H√£y ƒë∆∞a ra 1-2 g·ª£i √Ω cho "internalTransportation", bao g·ªìm m·ªôt kho·∫£n chi ph√≠ chung (taxi, grab) ·ªü m·ª©c R·∫§T H·ª¢P L√ù V√Ä TH·ª∞C T·∫æ (v√≠ d·ª•: kho·∫£ng 300,000-500,000 VNƒê cho to√†n chuy·∫øn ƒëi, ƒë∆°n v·ªã t√≠nh 'fixedForTrip') v√† m·ªôt l·ª±a ch·ªçn thu√™ xe m√°y n·∫øu ph√π h·ª£p (ƒë∆°n v·ªã t√≠nh 'perDay').
                     - H√£y ƒë∆∞a ra 2-3 g·ª£i √Ω cho "mainTransportation" v√† 5-7 g·ª£i √Ω cho c√°c danh m·ª•c c√≤n l·∫°i.`;
                }

                discoveryLoader.classList.remove('hidden');
                if (!isRefresh) { 
                    discoveryContent.innerHTML = '';
                }
                
                try {
                    const newSuggestionData = await callGeminiAPI(userPrompt);
                    renderDiscoverySuggestions(newSuggestionData.suggestions, isRefresh);
                    discoveryActions.classList.remove('hidden');
                } catch (error) {
                     console.error('Error in Discovery Mode:', error);
                    discoveryContent.innerHTML = `<p class="text-red-600 font-semibold p-4 bg-red-100 rounded-md card">ƒê√£ c√≥ l·ªói x·∫£y ra khi l·∫•y g·ª£i √Ω: ${error.message}</p>`;
                } finally {
                     discoveryLoader.classList.add('hidden');
                }
            };
            
            const renderDiscoverySuggestions = (newSuggestions, isRefresh) => {
                const categoryMap = {
                    mainTransportation: { name: 'Di chuy·ªÉn ch√≠nh (Kh·ª© h·ªìi)', icon: 'fa-plane-departure', items: [] },
                    internalTransportation: { name: 'Di chuy·ªÉn n·ªôi b·ªô', icon: 'fa-taxi', items: [] },
                    accommodation: { name: 'Ch·ªó ·ªü', icon: 'fa-hotel', items: [] },
                    food: { name: 'ƒÇn u·ªëng', icon: 'fa-utensils', items: [] },
                    activities: { name: 'Ho·∫°t ƒë·ªông & Tham quan', icon: 'fa-camera-retro', items: [] }
                };

                if (isRefresh) {
                    // Preserve existing checked items and the entire transportation card
                    document.querySelectorAll('.discovery-item').forEach(el => {
                        if (el.checked || el.dataset.category === 'mainTransportation' || el.dataset.category === 'internalTransportation') {
                            const category = el.dataset.category;
                            if (categoryMap[category]) {
                                categoryMap[category].items.push(createDiscoveryItemHtml({
                                    id: el.id,
                                    name: el.dataset.name,
                                    description: el.closest('.flex.items-start.justify-between').querySelector('p')?.textContent || '',
                                    estimatedCost: parseFloat(el.dataset.cost),
                                    unit: el.dataset.unit,
                                    category: category
                                }, el.checked, el.disabled));
                            }
                        }
                    });
                }

                // Integrate new suggestions, avoiding duplicates
                for (const key in newSuggestions) {
                    if (newSuggestions[key] && categoryMap[key]) {
                        const items = Array.isArray(newSuggestions[key]) ? newSuggestions[key] : [newSuggestions[key]];
                        items.forEach((item, index) => {
                            const isExisting = discoveryContent.querySelector(`#${item.id}`) !== null;
                            if (!isExisting) {
                                let isChecked = false, isDisabled = false;
                                
                                // REMOVED: Logic to auto-check and disable the first internal transportation item.
                                // All internal transportation options are now optional.

                                categoryMap[key].items.push(createDiscoveryItemHtml({ ...item, category: key }, isChecked, isDisabled));
                            }
                        });
                    }
                }
                
                discoveryContent.innerHTML = ''; 
                for (const key in categoryMap) {
                     if (categoryMap[key].items.length > 0) {
                        const card = document.createElement('div');
                        card.className = 'card p-6';
                        card.id = `card-${key}`;
                        card.innerHTML = `
                            <h3 class="text-lg font-semibold text-gray-700 flex items-center mb-2">
                                <i class="fas ${categoryMap[key].icon} mr-3 text-lg w-6 text-center text-blue-500"></i> ${categoryMap[key].name}
                            </h3>
                            <div>${categoryMap[key].items.join('')}</div>`;
                        discoveryContent.appendChild(card);
                    }
                }

                document.querySelectorAll('.discovery-item').forEach(item => {
                    item.addEventListener('change', updateTotals);
                });
                updateTotals(); 
            };


            const createDiscoveryItemHtml = (item, isChecked, isDisabled = false) => {
                const cost = parseFloat(item.estimatedCost) || 0;
                return `
                    <div class="flex items-start justify-between py-3 border-b last:border-b-0">
                        <div class="flex items-start">
                            <input type="checkbox" id="${item.id}" class="h-5 w-5 mt-1 text-blue-600 border-gray-300 rounded focus:ring-blue-500 discovery-item"
                                   data-cost="${cost}" data-unit="${item.unit}" data-name="${item.name}" data-category="${item.category}" 
                                   ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                            <div class="ml-4">
                                <label for="${item.id}" class="font-semibold text-gray-800 ${!isDisabled ? 'cursor-pointer' : ''}">${item.name}</label>
                                <p class="text-sm text-gray-500">${item.description}</p>
                            </div>
                        </div>
                        <span class="font-semibold text-blue-600 whitespace-nowrap">${formatCurrency(cost)}</span>
                    </div>`;
            };

            const updateDiscoveryTotal = () => {
                let total = 0;
                const duration = parseInt(budgetData.details.duration) || 1;
                const adults = parseInt(budgetData.details.adults) || 1;
                
                document.querySelectorAll('.discovery-item:checked').forEach(item => {
                    const cost = parseFloat(item.dataset.cost) || 0;
                    const unit = item.dataset.unit;
                    let itemTotal = 0;
                    
                    switch(unit) {
                        case 'perNight':
                            // Calculate nights: duration - 1. Ensure it's not negative.
                            itemTotal = cost * (duration > 1 ? duration - 1 : 0);
                            break;
                        case 'perPersonPerMeal':
                            // Cost is for one meal for all adults
                            itemTotal = cost * adults;
                            break;
                        case 'perDay':
                             itemTotal = cost * duration;
                             break;
                        case 'perPerson':
                        case 'perPersonRoundtrip':
                            itemTotal = cost * adults;
                            break;
                        case 'fixedForTrip':
                            itemTotal = cost;
                            break;
                        default:
                            itemTotal = cost;
                    }
                    total += itemTotal;
                });
                return total;
            };

            const callGeminiAPI = async (prompt) => {
                 const apiKey = "";
                 const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                 const payload = { contents: [{ parts: [{ text: prompt }] }] };
                 const response = await fetch(apiUrl, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });

                 if (!response.ok) {
                     const errorText = await response.text();
                     throw new Error(`L·ªói API: ${response.status} - ${errorText}`);
                 }

                 const result = await response.json();
                 const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                 if (!generatedText) throw new Error("AI kh√¥ng tr·∫£ v·ªÅ n·ªôi dung.");

                 const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
                 if (!jsonMatch) throw new Error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu JSON h·ª£p l·ªá trong ph·∫£n h·ªìi c·ªßa AI.");
                 
                 return JSON.parse(jsonMatch[0]);
            };

            generatePlanBtn.addEventListener('click', async () => {
                saveDetails(); 
                const { destination, duration, startingPoint } = budgetData.details;

                if (!destination || !duration || !startingPoint) {
                    const targetContent = currentMode === 'auto' ? itineraryContent : discoveryContent;
                    targetContent.innerHTML = `<p class="text-amber-700 font-semibold p-4 bg-amber-100 rounded-md card">Vui l√≤ng nh·∫≠p ƒêi·ªÉm xu·∫•t ph√°t, ƒêi·ªÉm ƒë·∫øn v√† S·ªë ng√†y ƒë·ªÉ t·∫°o k·∫ø ho·∫°ch.</p>`;
                    saveData();
                    return;
                }
                
                generatePlanBtn.disabled = true;
                generatePlanBtn.classList.add('opacity-50', 'cursor-not-allowed');

                if (currentMode === 'auto') {
                    await handleAutoMode(budgetData.details);
                } else {
                    await handleDiscoveryMode(budgetData.details, false);
                }

                generatePlanBtn.disabled = false;
                generatePlanBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                saveData();
            });

            findMoreSuggestionsBtn.addEventListener('click', async () => {
                findMoreSuggestionsBtn.disabled = true;
                findMoreSuggestionsBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang t√¨m ki·∫øm...`;

                await handleDiscoveryMode(budgetData.details, true);

                findMoreSuggestionsBtn.disabled = false;
                findMoreSuggestionsBtn.innerHTML = `<i class="fas fa-sync-alt mr-2"></i> T√¨m th√™m g·ª£i √Ω m·ªõi`;
            });

            
            const generateAutoModePdf = async () => {
                const printableContent = document.createElement('div');
                printableContent.style.position = 'absolute';
                printableContent.style.left = '-9999px';
                printableContent.style.width = '800px'; 
                printableContent.style.fontFamily = "'Inter', sans-serif";
                document.body.appendChild(printableContent);

                try {
                    const elementsToClone = [
                        document.getElementById('trip-details-card'),
                        document.getElementById('itinerary-card'),
                        ...document.querySelectorAll('#categories-container > .card'),
                        document.getElementById('summary-card')
                    ].filter(el => el && window.getComputedStyle(el).display !== 'none');

                    elementsToClone.forEach(el => {
                        const clone = el.cloneNode(true);
                        clone.style.marginBottom = '20px';
                        printableContent.appendChild(clone);
                    });

                    const canvas = await html2canvas(printableContent, {
                        scale: 2,
                        useCORS: true,
                        windowWidth: printableContent.scrollWidth,
                        windowHeight: printableContent.scrollHeight
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgRatio = canvas.width / canvas.height;
                    const imgHeightInPdf = pdfWidth / imgRatio;

                    let heightLeft = imgHeightInPdf;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeightInPdf);
                    heightLeft -= pdfHeight;

                    while (heightLeft > 0) {
                        position -= pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeightInPdf);
                        heightLeft -= pdfHeight;
                    }

                    pdf.save(`ke-hoach-${budgetData.details.destination || 'custom'}.pdf`);
                } finally {
                    document.body.removeChild(printableContent);
                }
            };
            
            const generateDiscoveryModePdf = async () => {
                const { details } = budgetData;
                const printableArea = document.getElementById('printable-discovery');
                
                const selectedItems = {};
                document.querySelectorAll('.discovery-item:checked').forEach(el => {
                    const category = el.dataset.category;
                    if (!selectedItems[category]) {
                        selectedItems[category] = [];
                    }
                     selectedItems[category].push({
                        name: el.dataset.name,
                        costText: formatCurrency(parseFloat(el.dataset.cost) || 0)
                    });
                });

                let printableHtml = `
                    <div style="font-family: 'Inter', sans-serif; padding: 25px; color: #333; width: 800px; font-size: 14px;">
                        <div style="text-align: center; margin-bottom: 25px;">
                            <h1 style="font-size: 28px; font-weight: 700; color: #1e3a8a; margin: 0; padding-bottom: 10px; border-bottom: 2px solid #ddd;">K·∫ø ho·∫°ch Du l·ªãch T·ª± ch·ªçn</h1>
                        </div>
                        <div style="margin-bottom: 20px; padding: 15px; background-color: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h2 style="font-size: 18px; font-weight: 600; color: #1e40af; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; margin-top: 0; margin-bottom: 10px;">Th√¥ng tin chuy·∫øn ƒëi</h2>
                            <p style="margin: 5px 0;"><strong>T·ª´:</strong> ${details.startingPoint}</p>
                            <p style="margin: 5px 0;"><strong>ƒê·∫øn:</strong> ${details.destination}</p>
                            <p style="margin: 5px 0;"><strong>Th·ªùi gian:</strong> ${details.duration} ng√†y</p>
                            <p style="margin: 5px 0;"><strong>S·ªë ng∆∞·ªùi:</strong> ${details.adults} ng∆∞·ªùi l·ªõn, ${details.children} tr·∫ª em</p>
                        </div>
                `;

                const categoryMap = {
                    mainTransportation: 'Di chuy·ªÉn ch√≠nh', internalTransportation: 'Di chuy·ªÉn n·ªôi b·ªô',
                    accommodation: 'Ch·ªó ·ªü', food: 'ƒÇn u·ªëng', activities: 'Ho·∫°t ƒë·ªông & Tham quan'
                };

                for (const category in categoryMap) {
                    if (selectedItems[category] && selectedItems[category].length > 0) {
                        printableHtml += `<div style="margin-bottom: 20px;">
                            <h2 style="font-size: 18px; font-weight: 600; color: #1e40af; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; margin-top: 0; margin-bottom: 10px;">${categoryMap[category]}</h2>
                            <ul style="list-style-type: none; padding-left: 0; margin: 0;">`;
                        selectedItems[category].forEach(item => {
                             printableHtml += `<li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f3f4f6;"><span>${item.name}</span><strong style="font-weight: 600;">${item.costText}</strong></li>`;
                        });
                        printableHtml += `</ul></div>`;
                    }
                }

                printableHtml += `
                    <div style="margin-top: 30px; border-top: 2px solid #3b82f6; padding-top: 15px; text-align: right;">
                        <h2 style="font-size: 22px; font-weight: 700; color: #be123c; margin: 0;">T·ªîNG CHI PH√ç D·ª∞ T√çNH: ${grandTotalElement.textContent}</h2>
                    </div></div>`;
                
                printableArea.innerHTML = printableHtml;
                printableArea.classList.remove('hidden');

                try {
                    const canvas = await html2canvas(printableArea, { scale: 2 });
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgRatio = canvas.width / canvas.height;
                    const imgHeightInPdf = pdfWidth / imgRatio;
                    
                    let heightLeft = imgHeightInPdf;
                    let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeightInPdf);
                    heightLeft -= pdfHeight;

                    while (heightLeft > 0) {
                        position -= pdfHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeightInPdf);
                        heightLeft -= pdfHeight;
                    }
                    pdf.save(`kham-pha-${details.destination}.pdf`);
                } finally {
                    printableArea.innerHTML = '';
                    printableArea.classList.add('hidden');
                }
            };

            const showAlert = (title, message) => {
                alertModalTitle.textContent = title;
                alertModalMessage.textContent = message;
                alertModal.classList.remove('hidden');
            };

            alertModalClose.addEventListener('click', () => {
                alertModal.classList.add('hidden');
            });

            downloadPdfButton.addEventListener('click', async () => {
                if (typeof html2canvas === 'undefined' || typeof window.jspdf === 'undefined') {
                    showAlert('Th∆∞ vi·ªán ch∆∞a s·∫µn s√†ng', 'Th∆∞ vi·ªán t·∫°o PDF ch∆∞a t·∫£i xong. Vui l√≤ng ƒë·ª£i v√†i gi√¢y v√† th·ª≠ l·∫°i.');
                    return;
                }

                downloadPdfButton.disabled = true;
                downloadPdfButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang x·ª≠ l√Ω...`;

                try {
                    if (currentMode === 'discovery') {
                        await generateDiscoveryModePdf();
                    } else {
                        await generateAutoModePdf();
                    }
                } catch (error) {
                    console.error("L·ªói khi t·∫°o PDF:", error);
                    showAlert('L·ªói t·∫°o PDF', `ƒê√£ c√≥ l·ªói x·∫£y ra: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                } finally {
                     downloadPdfButton.disabled = false;
                     downloadPdfButton.innerHTML = `<i class="fas fa-file-pdf mr-2"></i> T·∫£i K·∫ø ho·∫°ch (PDF)`;
                     updateActionButtonsState();
                }
            });
            

            resetButton.addEventListener('click', () => { confirmModal.classList.remove('hidden'); });
            confirmNoBtn.addEventListener('click', () => { confirmModal.classList.add('hidden'); });
            confirmYesBtn.addEventListener('click', () => {
                localStorage.removeItem('travelBudget');
                location.reload();
            });
            budgetModalCloseBtn.addEventListener('click', () => { budgetModal.classList.add('hidden'); });

            // Initial render
            switchMode('auto');
            renderUI();
        });
    </script>
</body>
</html>

